name: Build Flutter APK

on:
  push:
    branches:
      - main
      - 'claude/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Check and create Flutter project structure
        working-directory: ./frontend
        run: |
          if [ ! -d "android" ]; then
            echo "Creating Flutter project structure..."
            flutter create --platforms=android .
            echo "âœ… Android platform files created"
          else
            echo "âœ… Android platform files already exist"
          fi

      - name: Update Kotlin version
        working-directory: ./frontend
        run: |
          echo "Updating Kotlin to 1.9.22 for compatibility..."

          # Update settings.gradle (Flutter 3.19+)
          if [ -f "android/settings.gradle" ]; then
            sed -i 's/id "org.jetbrains.kotlin.android" version "[^"]*"/id "org.jetbrains.kotlin.android" version "1.9.22"/g' android/settings.gradle
            echo "âœ… Updated Kotlin in settings.gradle"
          fi

          # Update build.gradle (older Flutter versions)
          if [ -f "android/build.gradle" ]; then
            sed -i "s/ext.kotlin_version = '[^']*'/ext.kotlin_version = '1.9.22'/g" android/build.gradle
            echo "âœ… Updated Kotlin in build.gradle"
          fi

          echo "âœ… Kotlin version updated successfully"

      - name: Update Gradle version
        working-directory: ./frontend/android
        run: |
          echo "Updating Gradle wrapper to 8.3..."
          ./gradlew wrapper --gradle-version 8.3 --distribution-type all
          echo "âœ… Gradle wrapper updated to 8.3"

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            frontend/android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('frontend/android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Get Flutter dependencies
        working-directory: ./frontend
        run: flutter pub get

      - name: Generate Freezed code
        working-directory: ./frontend
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Analyze code
        working-directory: ./frontend
        run: flutter analyze --no-fatal-infos
        continue-on-error: true

      - name: Build APK
        working-directory: ./frontend
        run: flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: frontend/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: Create release notes
        working-directory: ./frontend
        run: |
          echo "## Service Platform v2.0 - Prototype APK" > release-notes.txt
          echo "" >> release-notes.txt
          echo "**Build Date**: $(date +'%Y-%m-%d %H:%M:%S')" >> release-notes.txt
          echo "**Commit**: ${{ github.sha }}" >> release-notes.txt
          echo "**Branch**: ${{ github.ref_name }}" >> release-notes.txt
          echo "" >> release-notes.txt
          echo "### Features:" >> release-notes.txt
          echo "- ğŸ“± Feed with 3-column staggered grid" >> release-notes.txt
          echo "- ğŸ” Search (Masters & Posts)" >> release-notes.txt
          echo "- ğŸ’¬ Chats with message bubbles" >> release-notes.txt
          echo "- ğŸ”” Notifications (11 types)" >> release-notes.txt
          echo "- ğŸ‘¤ Profile with user posts" >> release-notes.txt
          echo "" >> release-notes.txt
          echo "### Tech Stack:" >> release-notes.txt
          echo "- Flutter 3.24.0" >> release-notes.txt
          echo "- Riverpod 2.4.9" >> release-notes.txt
          echo "- Material Design 3" >> release-notes.txt
          echo "" >> release-notes.txt
          echo "**Note**: This is a prototype with mock data" >> release-notes.txt

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: frontend/release-notes.txt
          retention-days: 30

      - name: Get APK info
        working-directory: ./frontend
        run: |
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          echo "APK_SIZE=$APK_SIZE" >> $GITHUB_ENV
          echo "âœ… APK built successfully!"
          echo "ğŸ“¦ Size: $APK_SIZE"
          echo "ğŸ“ Path: build/app/outputs/flutter-apk/app-release.apk"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ“± APK Build Success!\n\nâœ… Android APK built successfully\n\n**Size**: ${{ env.APK_SIZE }}\n**Download**: Check the artifacts section above\n\n**Features**:\n- ğŸ“± Feed (3-column grid)\n- ğŸ” Search\n- ğŸ’¬ Chats\n- ğŸ”” Notifications (11 types)\n- ğŸ‘¤ Profile\n\n**Note**: Mock data prototype`
            })
