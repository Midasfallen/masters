# Исправление Runtime ошибок при тестировании

## 1. TypeError: null is not a subtype of type 'String'

### Проблема
Ошибка возникает при парсинге JSON, когда бэкенд возвращает `null` для поля, которое во Flutter модели объявлено как `required String` (не nullable).

### Причина
Автогенерируемые файлы `.g.dart` используют прямые касты `as String` без проверки на null. Если бэкенд вернет null для обязательного поля, возникает TypeError.

### Решение

#### ✅ Исправлено в CommentModel
Добавлены безопасные проверки в кастомном `fromJson`:
```dart
id: (jsonWithDefaults['id'] ?? '') as String,
postId: (jsonWithDefaults['postId'] ?? '') as String,
authorId: (jsonWithDefaults['authorId'] ?? '') as String,
content: (jsonWithDefaults['content'] ?? '') as String,
```

#### ⚠️ Потенциальные проблемы в других моделях

**PostModel** - автогенерируемый `fromJson` может упасть если:
- `id` или `authorId` будут null
- `createdAt` или `updatedAt` будут null

**Решение:** Если проблема повторится, нужно добавить кастомный `fromJson` для `PostModel` аналогично `CommentModel`.

### Где проверить
1. **DevTools → Console** - найти точную строку с ошибкой
2. **Network → Response** - проверить, какие поля приходят как null
3. **Backend logs** - убедиться, что бэкенд не возвращает null для обязательных полей

---

## 2. 400 Bad Request при создании поста

### Проблема
`POST /api/v2/posts` возвращает 400 Bad Request.

### Возможные причины
1. **Пустой content** - бэкенд требует непустой `content` или наличие `media_urls`
2. **Неверный формат данных** - UUID невалидный, даты в неправильном формате
3. **Отсутствующие обязательные поля**

### Решение
✅ Добавлена дополнительная проверка перед отправкой:
```dart
final content = _contentController.text.trim();
if (content.isEmpty && _selectedMedia.isEmpty) {
  ScaffoldMessenger.of(context).showSnackBar(
    const SnackBar(content: Text('Добавьте описание или фото')),
  );
  return;
}
```

### Как проверить
1. Открыть **DevTools → Network**
2. Найти запрос `POST /api/v2/posts`
3. Посмотреть **Response** - там будет детальное сообщение от NestJS о том, какое поле невалидно

---

## 3. 404 Not Found для `/masters/:id/services` и `/masters/:id/reviews`

### Проблема
Эндпоинты не найдены на бэкенде.

### Возможные причины
1. Роуты не зарегистрированы в контроллере
2. Неправильный путь (например, нет префикса `/api/v2`)
3. ID мастера невалидный

### Решение
**Backend:** Проверить наличие роутов в `MastersController`:
```typescript
@Get(':id/services')
@Get(':id/reviews')
```

**Frontend:** Проверить, что используются правильные эндпоинты в `ApiEndpoints`.

---

## 4. CORS ошибка для аватарок (pravatar.cc)

### Проблема
```
Access to image at 'https://i.pravatar.cc/...' from origin 'http://localhost:58986' 
has been blocked by CORS policy.
```

### Причина
Внешний сервис `pravatar.cc` не разрешает загрузку изображений с localhost из-за CORS политики.

### Решение
Это **не критично** для разработки. Варианты:
1. **Игнорировать** - аватары будут показывать fallback (инициалы)
2. **Использовать свой бэкенд** для проксирования изображений
3. **Настроить CORS на pravatar.cc** (невозможно, внешний сервис)

### Текущее поведение
- `AppAvatar` автоматически показывает инициалы при ошибке загрузки
- Цвет генерируется на основе `userId`, поэтому пользователи узнаваемы

---

## 5. Lifecycle Channel Warnings

### Проблема
```
A message on the flutter/lifecycle channel was discarded...
```

### Решение
**Это не ошибка!** Это стандартное предупреждение Flutter Web при запуске. На работу приложения не влияет.

---

## Чек-лист для отладки

### Шаг 1: Найти точную ошибку
- [ ] Открыть **DevTools → Console**
- [ ] Найти красную ошибку с полным stack trace
- [ ] Определить, какая модель и какое поле вызывают проблему

### Шаг 2: Проверить данные от бэкенда
- [ ] Открыть **DevTools → Network**
- [ ] Найти запрос, который вызывает ошибку
- [ ] Посмотреть **Response** - какие поля null или невалидны

### Шаг 3: Исправить проблему
- [ ] Если проблема в модели - добавить кастомный `fromJson` с проверками
- [ ] Если проблема в бэкенде - исправить валидацию или дефолтные значения
- [ ] Перегенерировать `.g.dart` файлы: `flutter pub run build_runner build --delete-conflicting-outputs`

### Шаг 4: Проверить исправление
- [ ] Перезапустить приложение
- [ ] Повторить действие, которое вызывало ошибку
- [ ] Убедиться, что ошибка исчезла

---

## Известные исправления

### ✅ Исправлено
1. **CommentModel.fromJson** - добавлены безопасные проверки на null
2. **uploadPostMediaFromXFile** - исправлена проверка `file.name`
3. **CreatePostScreen** - добавлена проверка перед отправкой поста

### ⚠️ Требует внимания
1. **PostModel.fromJson** - может потребоваться кастомный `fromJson` если бэкенд вернет null для обязательных полей
2. **Backend валидация** - проверить, что бэкенд не возвращает null для обязательных полей
3. **404 ошибки** - проверить наличие роутов `/masters/:id/services` и `/masters/:id/reviews` на бэкенде

---

## Рекомендации

1. **Всегда проверяй Response в DevTools** перед исправлением ошибок
2. **Используй безопасные касты** в кастомных `fromJson` методах
3. **Добавляй fallback значения** для обязательных полей, которые могут быть null
4. **Логируй ошибки** для лучшей отладки в production
