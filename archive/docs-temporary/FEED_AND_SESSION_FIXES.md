# Исправления: Обновление ленты и сохранение сессии

## ✅ Исправлено

### 1. Обновление ленты после создания поста

**Проблема:** После создания поста лента не обновлялась автоматически. Нужно было перезагружать страницу (F5), чтобы увидеть новый пост.

**Решение:**
- Добавлен `WidgetsBindingObserver` в `FeedScreen` для отслеживания жизненного цикла приложения
- Лента обновляется при возврате приложения из фона (`AppLifecycleState.resumed`)
- Инвалидация провайдера после создания поста гарантирует обновление при следующем обращении

**Изменения:**
- `frontend/lib/features/feed/screens/feed_screen.dart` - добавлен `WidgetsBindingObserver`
- `frontend/lib/features/feed/screens/create_post_screen.dart` - добавлена инвалидация провайдера

### 2. Сохранение сессии

**Текущее состояние:**
- ✅ Токены сохраняются в `FlutterSecureStorage`
- ✅ Auto-login работает через `AuthNotifier.build()`
- ✅ Interceptor добавляет токен в запросы

**Возможная проблема:**
Если после F5 нужно заново логиниться, возможные причины:
1. `FlutterSecureStorage` на Web использует `localStorage` - проверить в DevTools → Application → Local Storage
2. `SplashScreen` может не дожидаться загрузки `AuthNotifier` - проверить таймаут
3. Токены могут не сохраняться из-за настроек браузера

**Рекомендации:**
- Проверить DevTools → Application → Local Storage на наличие ключей `access_token`, `refresh_token`
- Если ключи есть - проблема в логике проверки в `SplashScreen`
- Если ключей нет - проблема в сохранении токенов

## Как работает обновление ленты

### После создания поста:
1. Пост создается через `PostNotifier.createPost()`
2. Провайдер `feedPostsProvider` инвалидируется
3. При возврате на экран Feed лента автоматически обновляется

### При возврате на экран:
1. `FeedScreen.didChangeAppLifecycleState()` вызывается при возврате приложения из фона
2. Лента обновляется через `_loadFeed(refresh: true)`
3. Локальное состояние (`feedPostsListProvider`) обновляется свежими данными

### Ручное обновление:
- Пользователь может обновить ленту через pull-to-refresh (свайп вниз)

## Проверка работоспособности

### Обновление ленты:
1. ✅ Создать пост
2. ✅ Вернуться на экран Feed
3. ✅ Лента должна автоматически обновиться (или при следующем возврате на экран)

### Сохранение сессии:
1. ✅ Залогиниться в приложении
2. ✅ Проверить DevTools → Application → Local Storage
3. ✅ Нажать F5 для перезагрузки страницы
4. ✅ Должен автоматически залогиниться без ввода пароля

## Измененные файлы

1. ✅ `frontend/lib/features/feed/screens/feed_screen.dart`
   - Добавлен `WidgetsBindingObserver`
   - Добавлено обновление при возврате из фона

2. ✅ `frontend/lib/features/feed/screens/create_post_screen.dart`
   - Добавлена инвалидация провайдера после создания поста

3. ✅ `frontend/lib/core/providers/api/feed_provider.dart`
   - Уже инвалидирует провайдер в `createPost()` (было до исправления)

## Дополнительная документация

- `docs/FEED_REFRESH_FIX.md` - детальное описание исправления обновления ленты
- `docs/SESSION_PERSISTENCE.md` - информация о сохранении сессии

## Примечания

- Обновление ленты происходит при возврате на экран, а не сразу после создания поста
- Это сделано для оптимизации - не загружать данные, если пользователь не видит экран
- Если нужно мгновенное обновление, можно добавить оптимистичное обновление (добавить пост в список без запроса)
