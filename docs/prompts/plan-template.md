# Шаблон плана с делегированием субагентам и MCP

Готовый шаблон для создания планов с автоматическим делегированием субагентам и интеграцией MCP серверов.

---

## Структура шаблона

```markdown
# План: [Название задачи]

## Анализ задачи
- Тип задачи: [Backend/Frontend/Database/Testing/Integration/Documentation]
- Необходимые агенты: [список агентов]
- Критичные операции: [список операций с MCP]
- Оценка времени: [время выполнения]

## План выполнения

### Шаг 1: [Agent Type] [Название подзадачи]
КОНТЕКСТ:
- Связанные файлы: 
  - [путь к файлу 1]
  - [путь к файлу 2]
- Похожие паттерны: 
  - Используй паттерн из [путь к похожему модулю]
  - Пример: [конкретный пример]
- Документация:
  - [ссылка на docs если есть]
- Зависимости:
  - [список зависимостей]

ТРЕБОВАНИЯ:
- [требование 1 - конкретное и измеримое]
- [требование 2]
- [требование 3]

MCP ИСПОЛЬЗОВАНИЕ:
- [MCP сервер]: [описание использования]
- [MCP сервер]: [описание использования]

КРИТЕРИИ ВАЛИДАЦИИ:
- [критерий 1]
- [критерий 2]
- [критерий 3]

### Шаг 2: [Agent Type] [Название подзадачи]
...
```

---

## Типы агентов

### Backend Agent
- **Специализация:** NestJS, TypeORM, PostgreSQL, валидация DTO
- **Когда использовать:** API endpoints, модули, сервисы, контроллеры
- **MCP:** Postgres (для БД), Git (для коммитов), Memory (для контекста)

### Frontend Agent
- **Специализация:** Flutter, Riverpod, UI компоненты, навигация
- **Когда использовать:** Экраны, виджеты, провайдеры, UI компоненты
- **MCP:** Git (для коммитов), Memory (для контекста)

### Database Agent
- **Специализация:** Миграции, запросы, оптимизация индексов
- **Когда использовать:** Миграции, индексы, оптимизация БД
- **MCP:** Postgres (обязательно), Git (для коммитов), Memory (для контекста)

### Testing Agent
- **Специализация:** Unit тесты, E2E тесты, тестовые данные
- **Когда использовать:** Написание тестов, увеличение покрытия
- **MCP:** Git (для коммитов), Memory (для результатов)

### Integration Agent
- **Специализация:** API интеграция, WebSocket, внешние сервисы
- **Когда использовать:** Интеграция API, WebSocket, внешние сервисы
- **MCP:** Docker (для контейнеров), Redis (для кеша), Git (для коммитов)

### Documentation Agent
- **Специализация:** Обновление документации, API docs, README
- **Когда использовать:** Обновление документации, создание README
- **MCP:** Git (для коммитов), Memory (для контекста)

---

## MCP серверы и их использование

### Postgres MCP
**Когда использовать:**
- Перед созданием миграций (проверка структуры БД)
- После операций с БД (проверка данных)
- Перед изменением схемы (валидация)
- Для анализа производительности запросов

**Формат:**
```
MCP ИСПОЛЬЗОВАНИЕ:
- Postgres MCP: проверка структуры таблицы [table_name] перед созданием миграции
- Postgres MCP: проверка данных после операции [operation]
- Postgres MCP: анализ производительности запроса [query_description]
```

### Git MCP
**Когда использовать:**
- Перед коммитом (проверка статуса)
- После выполнения шага (создание коммита)
- Для просмотра истории изменений
- Для создания веток

**Формат:**
```
MCP ИСПОЛЬЗОВАНИЕ:
- Git MCP: проверка статуса перед коммитом изменений
- Git MCP: создание коммита "[commit message]" после валидации
- Git MCP: просмотр истории изменений для понимания контекста
```

### Docker MCP
**Когда использовать:**
- Перед запуском операций (проверка статуса контейнеров)
- Для диагностики проблем (просмотр логов)
- После изменений конфигурации

**Формат:**
```
MCP ИСПОЛЬЗОВАНИЕ:
- Docker MCP: проверка статуса контейнеров перед запуском
- Docker MCP: просмотр логов для диагностики ошибок
```

### Redis MCP
**Когда использовать:**
- Перед операциями с кешем (проверка данных)
- После изменений данных (очистка кеша)
- Для диагностики проблем с кешем

**Формат:**
```
MCP ИСПОЛЬЗОВАНИЕ:
- Redis MCP: проверка кеша перед операциями
- Redis MCP: очистка кеша после изменения данных
```

### Memory MCP
**Когда использовать:**
- После завершения каждого шага (сохранение результатов)
- Для сохранения архитектурных решений
- Для предотвращения повторной работы

**Формат:**
```
MCP ИСПОЛЬЗОВАНИЕ:
- Memory MCP: сохранение архитектурного решения [description] для будущих задач
- Memory MCP: сохранение результатов анализа [description] для предотвращения повторной работы
```

### Filesystem MCP
**Когда использовать:**
- Для чтения логов при диагностике
- Для анализа структуры файлов
- Для проверки конфигурационных файлов

**Формат:**
```
MCP ИСПОЛЬЗОВАНИЕ:
- Filesystem MCP: анализ структуры файлов перед рефакторингом
- Filesystem MCP: чтение логов для диагностики ошибок
```

### GitHub MCP
**Когда использовать:**
- Для создания issues для отслеживания задач
- Для просмотра PR для понимания контекста
- Для создания PR после завершения задачи

**Формат:**
```
MCP ИСПОЛЬЗОВАНИЕ:
- GitHub MCP: создание issue "[title]" для отслеживания задачи
- GitHub MCP: просмотр PR #[number] для понимания контекста
```

---

## Примеры использования шаблона

### Пример 1: Простая задача (один агент)

```markdown
# План: Создание экрана профиля пользователя

## Анализ задачи
- Тип задачи: Frontend
- Необходимые агенты: Frontend Agent
- Критичные операции: Git (коммит изменений)
- Оценка времени: 2-3 часа

## План выполнения

### Шаг 1: [Frontend Agent] Создание экрана профиля
КОНТЕКСТ:
- Связанные файлы: 
  - frontend/lib/features/profile/screens/profile_screen.dart
  - frontend/lib/core/models/api/user_model.dart
- Похожие паттерны: 
  - frontend/lib/features/feed/screens/feed_screen.dart
- Документация:
  - docs/design/UXUI-Guide-v2.md
- Зависимости:
  - Riverpod для state management
  - GoRouter для навигации

ТРЕБОВАНИЯ:
- Создать экран с отображением информации о пользователе
- Добавить возможность редактирования профиля
- Интегрировать с API для получения данных пользователя

MCP ИСПОЛЬЗОВАНИЕ:
- Git MCP: проверка статуса перед коммитом изменений
- Memory MCP: сохранение архитектурного решения для будущих экранов

КРИТЕРИИ ВАЛИДАЦИИ:
- Экран отображается без ошибок
- Данные пользователя загружаются корректно
- Навигация работает правильно
- Соответствует дизайн-гайду
```

### Пример 2: Сложная задача (несколько агентов)

```markdown
# План: Создание модуля уведомлений с real-time обновлениями

## Анализ задачи
- Тип задачи: Backend + Frontend + Integration
- Необходимые агенты: Backend Agent, Database Agent, Frontend Agent, Integration Agent, Testing Agent
- Критичные операции: Postgres (миграции), Git (коммиты), Memory (сохранение контекста)
- Оценка времени: 8-12 часов

## План выполнения

### Шаг 1: [Database Agent] Создание миграции для таблицы notifications
КОНТЕКСТ:
- Связанные файлы:
  - backend/src/database/migrations/
- Похожие паттерны:
  - backend/src/modules/posts/entities/post.entity.ts
- Документация:
  - docs/technical/Database.md

ТРЕБОВАНИЯ:
- Создать таблицу notifications с полями: id, user_id, type, title, message, read, created_at
- Добавить индексы на user_id и created_at
- Добавить foreign key на users

MCP ИСПОЛЬЗОВАНИЕ:
- Postgres MCP: проверка структуры таблицы users перед созданием foreign key
- Git MCP: проверка статуса перед коммитом миграции

КРИТЕРИИ ВАЛИДАЦИИ:
- Миграция выполняется без ошибок
- Таблица создана с правильной структурой
- Индексы созданы корректно

### Шаг 2: [Backend Agent] Создание модуля notifications
КОНТЕКСТ:
- Связанные файлы:
  - backend/src/modules/notifications/
- Похожие паттерны:
  - backend/src/modules/posts/
- Документация:
  - docs/technical/TechSpec.md

ТРЕБОВАНИЯ:
- Создать notifications.module.ts
- Создать notifications.controller.ts с CRUD endpoints
- Создать notifications.service.ts с бизнес-логикой
- Добавить Swagger документацию

MCP ИСПОЛЬЗОВАНИЕ:
- Postgres MCP: проверка данных после операций с БД
- Git MCP: проверка статуса перед коммитом
- Memory MCP: сохранение архитектурного решения для модулей

КРИТЕРИИ ВАЛИДАЦИИ:
- Модуль компилируется без ошибок
- API endpoints работают корректно
- Swagger документация добавлена

### Шаг 3: [Integration Agent] Настройка WebSocket для real-time обновлений
КОНТЕКСТ:
- Связанные файлы:
  - backend/src/modules/websocket/
- Похожие паттерны:
  - Существующая WebSocket конфигурация
- Документация:
  - docs/technical/TechSpec.md

ТРЕБОВАНИЯ:
- Настроить WebSocket для отправки уведомлений в real-time
- Интегрировать с notifications.service.ts
- Добавить обработку подключений и отключений

MCP ИСПОЛЬЗОВАНИЕ:
- Git MCP: проверка статуса перед коммитом
- Memory MCP: сохранение архитектурного решения для WebSocket

КРИТЕРИИ ВАЛИДАЦИИ:
- WebSocket подключение работает
- Уведомления отправляются в real-time
- Обработка ошибок реализована

### Шаг 4: [Frontend Agent] Создание экрана уведомлений
КОНТЕКСТ:
- Связанные файлы:
  - frontend/lib/features/notifications/
- Похожие паттерны:
  - frontend/lib/features/feed/screens/feed_screen.dart
- Документация:
  - docs/design/UXUI-Guide-v2.md

ТРЕБОВАНИЯ:
- Создать экран со списком уведомлений
- Интегрировать WebSocket для real-time обновлений
- Добавить возможность пометить уведомление как прочитанное

MCP ИСПОЛЬЗОВАНИЕ:
- Git MCP: проверка статуса перед коммитом
- Memory MCP: сохранение архитектурного решения для UI

КРИТЕРИИ ВАЛИДАЦИИ:
- Экран отображается без ошибок
- Уведомления загружаются корректно
- Real-time обновления работают
- Соответствует дизайн-гайду

### Шаг 5: [Testing Agent] Написание тестов
КОНТЕКСТ:
- Связанные файлы:
  - backend/src/modules/notifications/notifications.service.spec.ts
  - frontend/test/notifications_test.dart
- Похожие паттерны:
  - Существующие тесты в проекте

ТРЕБОВАНИЯ:
- Написать unit тесты для notifications.service.ts
- Написать E2E тесты для API endpoints
- Написать widget тесты для экрана уведомлений

MCP ИСПОЛЬЗОВАНИЕ:
- Git MCP: проверка статуса перед коммитом
- Memory MCP: сохранение результатов тестирования

КРИТЕРИИ ВАЛИДАЦИИ:
- Все тесты проходят
- Покрытие кода >= 80%
- E2E тесты проверяют основные сценарии
```

---

## Best Practices

### 1. Структурирование планов
- ✅ Всегда начинай с анализа задачи
- ✅ Явно указывай необходимых агентов
- ✅ Разбивай сложные задачи на подзадачи
- ✅ Определяй критерии валидации для каждого шага

### 2. Использование MCP
- ✅ Явно указывай MCP только для критичных операций
- ✅ Используй Postgres MCP для всех операций с БД
- ✅ Используй Git MCP для всех операций с Git
- ✅ Используй Memory MCP для сохранения контекста

### 3. Делегирование агентам
- ✅ Всегда предоставляй полный контекст агенту
- ✅ Указывай конкретные файлы и функции
- ✅ Приводи примеры из существующего кода
- ✅ Определяй четкие критерии валидации

---

## Дополнительные ресурсы

- [Полное руководство по режиму планирования](../CURSOR_PLAN_MODE.md)
- [Система оркестрации задач](../CURSOR_ORCHESTRATION.md)
- [Примеры планов](plan-examples.md)
