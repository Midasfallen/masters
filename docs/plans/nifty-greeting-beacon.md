# –ü–ª–∞–Ω: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —É—Å–ª—É–≥ –≤ Meilisearch

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∏—Å–∫ `/api/v2/search/all?q=–∫—Ä–∞—Å–æ` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã –¥–ª—è masters, services, categories, —Ö–æ—Ç—è –≤ –ë–î –µ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ö—Ä–∞—Å–æ—Ç–∞ –∏ —É—Ö–æ–¥".

**–î–∞—Ç–∞:** 6 —Ñ–µ–≤—Ä–∞–ª—è 2026

---

## üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**Timing Issue (–ø—Ä–æ–±–ª–µ–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è):**

1. NestJS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è ‚Üí `SearchService.onModuleInit()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
2. –ú–µ—Ç–æ–¥ `reindexAll()` ‚Üí `reindexCategories()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î
3. –ï—Å–ª–∏ –ë–î –ø—É—Å—Ç–∞—è (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫), –º–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Ä–∞–Ω–æ: `if (categories.length === 0) return;`
4. –ò–Ω–¥–µ–∫—Å Meilisearch –æ—Å—Ç–∞–µ—Ç—Å—è **–ø—É—Å—Ç—ã–º**
5. **–ü–æ–∑–∂–µ** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `npm run seed`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –ë–î
6. –ù–æ Meilisearch –∏–Ω–¥–µ–∫—Å —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ **–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—Å—Ç—å –≤ PostgreSQL, –Ω–æ **–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç** –≤ Meilisearch –∏–Ω–¥–µ–∫—Å–µ.

---

## üìã –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: Admin endpoint –¥–ª—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ (–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–û–ï)

**–ü–ª—é—Å—ã:**
- –ü—Ä–æ—Å—Ç–æ–µ –∏ –±—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ seed'–∞
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
- –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –±—É–¥—É—â–µ–π –æ—Ç–ª–∞–¥–∫–∏

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**

1. **–°–æ–∑–¥–∞—Ç—å Admin –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä** (–µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç)
   - –§–∞–π–ª: `backend/src/modules/admin/admin.controller.ts`
   - –î–æ–±–∞–≤–∏—Ç—å endpoint: `POST /admin/search/reindex`

2. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏**
   - `POST /admin/search/reindex-all` - –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç –≤—Å—ë (–º–∞—Å—Ç–µ—Ä–∞, —É—Å–ª—É–≥–∏, —à–∞–±–ª–æ–Ω—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
   - `POST /admin/search/reindex-categories` - —Ç–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   - `POST /admin/search/reindex-services` - —Ç–æ–ª—å–∫–æ —É—Å–ª—É–≥–∏
   - `POST /admin/search/reindex-masters` - —Ç–æ–ª—å–∫–æ –º–∞—Å—Ç–µ—Ä–∞

3. **–ó–∞—â–∏—Ç–∏—Ç—å endpoint**
   - JWT Guard —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–æ–ª–∏ `admin`
   - –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ–π API –∫–ª—é—á –¥–ª—è dev –æ–∫—Ä—É–∂–µ–Ω–∏—è

4. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Swagger**
   - –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ endpoint'–æ–≤
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 2: –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–î–û–õ–ì–û–°–†–û–ß–ù–û–ï)

**–ò–∑–º–µ–Ω–∏—Ç—å:** `SearchService.onModuleInit()` ‚Üí `SearchService.onApplicationBootstrap()`

**–ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–µ:**
- `onApplicationBootstrap()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–ø–æ—Å–ª–µ** –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
- –ë–æ–ª—å—à–µ —à–∞–Ω—Å–æ–≤, —á—Ç–æ –ë–î —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
- –ù–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, –µ—Å–ª–∏ seed –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ

### –†–µ—à–µ–Ω–∏–µ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ (–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï)

**–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `searchCategories()`:**
```typescript
async searchCategories(query, language, limit, offset) {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—É—Å—Ç –ª–∏ –∏–Ω–¥–µ–∫—Å
  const stats = await this.categoriesIndex.getStats();
  if (stats.numberOfDocuments === 0) {
    await this.reindexCategories(); // –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  }

  // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∏—Å–∫
  return await this.categoriesIndex.search(query, {...});
}
```

**–ü–ª—é—Å—ã:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–ú–∏–Ω—É—Å—ã:** –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–º (–ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è on-demand)

---

## üõ† –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:** –°–æ–∑–¥–∞—Ç—å admin endpoint –¥–ª—è —Ä—É—á–Ω–æ–π –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
2. **–ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
3. **–í production:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å scheduled task –¥–ª—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–µ N —á–∞—Å–æ–≤

---

## üìÅ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –°–æ–∑–¥–∞—Ç—å Admin Module (–µ—Å–ª–∏ –Ω–µ—Ç)

**–§–∞–π–ª:** `backend/src/modules/admin/admin.module.ts`
```typescript
@Module({
  imports: [SearchModule],
  controllers: [AdminController],
  providers: [],
})
export class AdminModule {}
```

### 2. –°–æ–∑–¥–∞—Ç—å Admin Controller

**–§–∞–π–ª:** `backend/src/modules/admin/admin.controller.ts`

**Endpoints:**
- `POST /admin/search/reindex-all` ‚Üí –≤—ã–∑–æ–≤ `SearchService.reindexAll()`
- `POST /admin/search/reindex-categories` ‚Üí –≤—ã–∑–æ–≤ `SearchService.reindexCategories()`
- `POST /admin/search/reindex-services` ‚Üí –≤—ã–∑–æ–≤ `SearchService.reindexServices()`
- `POST /admin/search/reindex-masters` ‚Üí –≤—ã–∑–æ–≤ `SearchService.reindexMasters()`
- `GET /admin/search/stats` ‚Üí —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ Meilisearch

### 3. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å SearchService (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–§–∞–π–ª:** `backend/src/modules/search/search.service.ts`

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `getIndexStats()`:**
```typescript
async getIndexStats() {
  return {
    masters: await this.mastersIndex.getStats(),
    services: await this.servicesIndex.getStats(),
    service_templates: await this.serviceTemplatesIndex.getStats(),
    categories: await this.categoriesIndex.getStats(),
  };
}
```

### 4. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å AdminModule

**–§–∞–π–ª:** `backend/src/app.module.ts`

```typescript
@Module({
  imports: [
    // ...
    AdminModule, // –î–æ–±–∞–≤–∏—Ç—å
  ],
})
```

### 5. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

**–§–∞–π–ª:** `docs/SEARCH_TABS_PLAN.md` (—Å–µ–∫—Ü–∏—è "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ MCP")

–î–æ–±–∞–≤–∏—Ç—å:
```markdown
## –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ—Å–ª–µ seed'–∞

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ `npm run seed` –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Meilisearch:

```bash
# –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë
curl -X POST http://localhost:3000/api/v2/admin/search/reindex-all

# –ò–ª–∏ —Ç–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
curl -X POST http://localhost:3000/api/v2/admin/search/reindex-categories
```
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ seed:**
   ```bash
   cd backend
   npm run start:dev
   npm run seed
   ```

2. **–í—ã–∑–≤–∞—Ç—å –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é:**
   ```bash
   curl -X POST http://localhost:3000/api/v2/admin/search/reindex-all
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–Ω–¥–µ–∫—Å–æ–≤:**
   ```bash
   curl http://localhost:3000/api/v2/admin/search/stats
   ```

   –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   ```json
   {
     "categories": { "numberOfDocuments": 63 },  // 10 L0 + 53 L1
     "service_templates": { "numberOfDocuments": 340+ },
     "masters": { "numberOfDocuments": 5 },
     "services": { "numberOfDocuments": 20+ }
   }
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∏—Å–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:**
   ```bash
   curl "http://localhost:3000/api/v2/search/all?q=–∫—Ä–∞—Å–æ&limit=10&language=ru"
   ```

   –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   ```json
   {
     "masters": [...],
     "services": [...],
     "categories": [
       {
         "id": "..._ru",
         "category_id": "...",
         "name": "–ö—Ä–∞—Å–æ—Ç–∞ –∏ —É—Ö–æ–¥",
         "slug": "krasota-i-uhod",
         "level": 0,
         "name_highlighted": "<em>–ö—Ä–∞—Å–æ</em>—Ç–∞ –∏ —É—Ö–æ–¥"
       },
       {
         "name": "–ü–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫–∏–µ —É—Å–ª—É–≥–∏",
         ...
       }
     ],
     "query": "–∫—Ä–∞—Å–æ",
     "processing_time_ms": 15
   }
   ```

5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å UI –≤ –±—Ä–∞—É–∑–µ—Ä–µ:**
   - –û—Ç–∫—Ä—ã—Ç—å `http://localhost:3001` (Flutter Web)
   - –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —ç–∫—Ä–∞–Ω –ø–æ–∏—Å–∫–∞
   - –í–≤–µ—Å—Ç–∏ "–∫—Ä–∞—Å–æ"
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–∞–±—ã "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏" —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

---

## üîß –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π quick fix (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø–æ–∏—Å–∫–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:

1. **–û—Ç–∫—Ä—ã—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª –≤ backend:**
   ```bash
   cd backend
   npm run repl
   ```

2. **–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é:**
   ```javascript
   const searchService = get('SearchService');
   await searchService.reindexAll();
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   ```bash
   curl "http://localhost:3000/api/v2/search/all?q=–∫—Ä–∞—Å–æ&limit=10&language=ru"
   ```

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```
backend/src/modules/
‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îú‚îÄ‚îÄ admin.module.ts           [–ù–û–í–´–ô]
‚îÇ   ‚îú‚îÄ‚îÄ admin.controller.ts       [–ù–û–í–´–ô]
‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ       ‚îî‚îÄ‚îÄ reindex-response.dto.ts [–ù–û–í–´–ô]
‚îú‚îÄ‚îÄ search/
‚îÇ   ‚îî‚îÄ‚îÄ search.service.ts         [–ò–ó–ú–ï–ù–ò–¢–¨ - –¥–æ–±–∞–≤–∏—Ç—å getIndexStats()]
‚îî‚îÄ‚îÄ app.module.ts                 [–ò–ó–ú–ï–ù–ò–¢–¨ - –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å AdminModule]

docs/
‚îî‚îÄ‚îÄ SEARCH_TABS_PLAN.md           [–û–ë–ù–û–í–ò–¢–¨ - –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏]
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –°–æ–∑–¥–∞—Ç—å AdminModule –∏ AdminController —Å endpoint'–∞–º–∏ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
2. –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É endpoint'–æ–≤ (JWT + role check)
3. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Swagger
4. –û–±–Ω–æ–≤–∏—Ç—å SEARCH_TABS_PLAN.md —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å flow: seed ‚Üí reindex ‚Üí search
6. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
