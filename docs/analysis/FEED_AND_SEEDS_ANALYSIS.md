# Анализ: лента постов не грузится и связь сидов с MinIO/API

**Дата:** 5 февраля 2026  
**Проблема:** после запуска приложения лента постов не отображается (401), возможна рассинхронизация тестовых данных с MinIO и API.

---

## 1. Почему лента не грузится (401)

### Цепочка запросов из лога

1. **GET /users/me** → 401 «Пользователь не найден»  
   Нет валидного токена или пользователь не в БД.

2. **POST /auth/logout** → 404 «Cannot POST /api/v2/auth/logout»  
   Эндпоинт выхода в бэкенде отсутствует.

3. **POST /auth/login** с `ravinski.genlawyer@gmail.com` / `qwerty123` → 401 «Неверный email или пароль»  
   Этот пользователь не создаётся сидами.

4. **GET /posts/feed** → 401 Unauthorized  
   Лента требует авторизации (`@CurrentUser('id')` в контроллере). Без успешного логина токена нет → 401 ожидаем.

### Вывод

- Лента **намеренно** доступна только авторизованным пользователям.
- Пользователь входит своим email/паролем, которых нет в БД после сида.
- В основном сиде (`seed.ts`) создаются пользователи с **случайными email (faker)** и паролем **`Password123!`**, а не фиксированные `*@test.com` с паролем `test123`, как в SEEDING.md.
- Итог: после `npm run seed` нельзя войти по документированным в SEEDING.md тестовым аккаунтам, лента без входа не отдаётся.

---

## 2. Расхождение сидов и документации

| Аспект | SEEDING.md | Фактически (seed.cli → seed.ts) |
|--------|------------|----------------------------------|
| Пользователи | 3 мастера (anna, dmitry, elena), 3 клиента (maria, ivan, olga), фиксированные email | 10 пользователей со **случайными email** (faker) |
| Пароль | `test123` | **`Password123!`** |
| Посты | «6 постов с медиа» | 20 постов **без записей в post_media** |
| post_media | подразумевается | **не создаётся** в основном сиде |

Файл `test-data.seed.ts` создаёт фиксированных мастеров/клиентов и post_media, но **нигде не вызывается**: `seed.cli.ts` запускает только `seedCatalog()` и `seed()`.

---

## 3. Связь постов с MinIO

- В **основном сиде** создаются только строки в `posts`. Таблица **post_media** не заполняется.
- Скрипт **upload-local-images.ts** обновляет уже существующие записи `post_media` URL-ами из MinIO. Если записей нет (`allPostMedia.length === 0`), он только пишет предупреждение и не создаёт медиа.
- Итог: после `npm run seed` у постов нет медиа; даже при наличии 24 изображений в MinIO они не привязываются к постам без записей в `post_media`.

---

## 4. Backend и новая структура БД

- Категории/шаблоны: миграция и сиды приведены к структуре L0/L1 + `service_templates`. API ленты постов от этой структуры не зависит.
- **GET /posts/feed** актуален, требует авторизации и отдаёт посты с пагинацией. Проблема не в «неактуальности API», а в отсутствии валидного токена и в том, что лента закрыта для неавторизованных.

---

## 5. Фронтенд

- Запрос к ленте идёт на `ApiEndpoints.postsFeed` с токеном из Dio-клиента. При 401 лента не показывается — поведение корректное при отсутствии/невалидности токена.
- Ошибка **404 на POST /auth/logout** говорит о том, что фронт ожидает эндпоинт выхода, которого нет на бэке.

---

## 6. Рекомендации (внедрённые и на перспективу)

### Сделано / планируется в коде

1. **POST /auth/logout**  
   Добавить эндпоинт (200 OK, клиент сбрасывает токены), чтобы убрать 404 и согласовать фронт с бэком.

2. **Фиксированные тестовые пользователи в основном сиде**  
   В `seed.ts` создавать 2–3 пользователя с известными email (например `master@test.com`, `client@test.com`) и паролем **test123**, чтобы после любого запуска сида можно было войти и открыть ленту.

3. **Создание post_media в основном сиде**  
   Для части постов (например, тип PHOTO) создавать записи в `post_media` с placeholder-URL (или сразу с путём вида `{MINIO_PUBLIC_URL}/posts/...`). Тогда:
   - лента будет возвращать посты с медиа;
   - скрипт загрузки изображений в MinIO сможет обновлять эти записи реальными URL (если использовать общий скрипт или тот же upload-local-images с доработкой под 24 файла).

4. **Обновление SEEDING.md**  
   Указать: какой сид реально запускается (`npm run seed` → seed.cli → catalog + main seed), фиксированные тестовые аккаунты и пароль test123, необходимость запуска `upload-images` для подмены URL медиа на MinIO.

### На перспективу

- **Единый скрипт для MinIO и БД:** сид или отдельная команда создаёт в MinIO бакет/объекты из набора из 24 изображений и проставляет URL в `post_media`, чтобы не зависеть от ручной папки на конкретной машине.
- **Опционально:** публичная лента (GET /posts/feed без авторизации, только публичные посты) — по продуктовому решению.

---

## 7. Как сейчас проверить ленту после доработок

1. Запустить сиды: `npm run seed`.
2. Войти с тестовым пользователем (например `master@test.com` / `test123` после добавления таких пользователей в сид).
3. Убедиться, что запрос GET /posts/feed уходит с заголовком `Authorization: Bearer <token>` и возвращает 200 и список постов.
4. При необходимости запустить загрузку изображений в MinIO и обновление URL в `post_media` (например, доработанный `upload-images` или аналог), после чего медиа в ленте будут вести на MinIO.
