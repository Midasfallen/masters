# Тестирование кнопки "Подписаться"

## Статус реализации

✅ Все компоненты реализованы согласно плану:
- `subscription_repository.dart` - исправлен метод `subscribe()`
- `subscriptions_provider.dart` - реализован `isFollowingProvider`
- `post_detail_screen.dart` - реализован `_toggleFollow()` с полной обработкой ошибок
- UI кнопки с паттерном ElevatedButton/OutlinedButton

## Чек-лист тестирования

### 1. Базовый сценарий: Подписка

**Шаги:**
1. Открыть приложение и войти в систему
2. Открыть пост от другого пользователя (не свой)
3. Проверить, что кнопка "Подписаться" отображается (белая кнопка с черным текстом)
4. Нажать "Подписаться"

**Ожидаемый результат:**
- ✅ В консоли браузера видно: `DEBUG: Toggle follow START: authorId=..., wasFollowing=false`
- ✅ В Network (DevTools) видно запрос `POST /api/v2/subscriptions` с body:
  ```json
  {
    "target_id": "uuid-автора",
    "notifications_enabled": true
  }
  ```
- ✅ Кнопка показывает `CircularProgressIndicator` во время запроса
- ✅ После успеха видно в консоли: `DEBUG: Toggle follow SUCCESS`
- ✅ Кнопка меняется на "Отписаться" (OutlinedButton с белым текстом)
- ✅ Появляется SnackBar: "Подписались на [Имя мастера]"
- ✅ Кнопка разблокируется после завершения запроса

**Проверка в DevTools:**
- Network tab: статус `201 Created` или `200 OK`
- Response содержит объект подписки

---

### 2. Базовый сценарий: Отписка

**Шаги:**
1. После успешной подписки (сценарий 1)
2. Нажать "Отписаться"

**Ожидаемый результат:**
- ✅ В консоли видно: `DEBUG: Toggle follow START: authorId=..., wasFollowing=true`
- ✅ В Network видно запрос `DELETE /api/v2/subscriptions/[userId]`
- ✅ Кнопка показывает `CircularProgressIndicator`
- ✅ После успеха видно: `DEBUG: Toggle follow SUCCESS`
- ✅ Кнопка меняется обратно на "Подписаться" (ElevatedButton)
- ✅ Появляется SnackBar: "Отписались от [Имя мастера]"

**Проверка в DevTools:**
- Network tab: статус `204 No Content` или `200 OK`

---

### 3. Защита от Race Conditions

**Шаги:**
1. Открыть пост от другого пользователя
2. Быстро нажать "Подписаться" 5 раз подряд (как можно быстрее)

**Ожидаемый результат:**
- ✅ В консоли видно только ОДИН `DEBUG: Toggle follow START`
- ✅ В Network видно только ОДИН запрос `POST /api/v2/subscriptions`
- ✅ Кнопка заблокирована (`onPressed: null`) во время запроса
- ✅ После завершения запроса кнопка разблокируется
- ✅ Состояние подписки корректное (подписан или не подписан)

**Проверка:**
- Флаг `_isTogglingFollow` должен блокировать повторные вызовы
- `ref.invalidate()` вызывается ПОСЛЕ `await`, а не до

---

### 4. Обработка ошибок: Нет интернета

**Шаги:**
1. Открыть DevTools → Network → выбрать "Offline"
2. Открыть пост от другого пользователя
3. Нажать "Подписаться"

**Ожидаемый результат:**
- ✅ В консоли видно: `DEBUG: Toggle follow ERROR: ...`
- ✅ Появляется красный SnackBar: "Ошибка: [описание ошибки]"
- ✅ Кнопка возвращается в исходное состояние (не меняется на "Отписаться")
- ✅ Состояние подписки не изменилось

**Проверка:**
- Ошибка обрабатывается в блоке `catch`
- Состояние откатывается через `ref.invalidate()`

---

### 5. Обработка ошибок: 409 Conflict

**Шаги:**
1. Подписаться на пользователя (сценарий 1)
2. Попытаться подписаться снова (не отписываясь)

**Ожидаемый результат:**
- ✅ В консоли видно: `DEBUG: Toggle follow ERROR: ...`
- ✅ В консоли видно: `DEBUG: Toggle follow ApiException status=409, data={...}`
- ✅ В Network видно запрос `POST /api/v2/subscriptions` со статусом `409 Conflict`
- ✅ Появляется обычный SnackBar (НЕ красный): "Уже подписаны на этого мастера"
- ✅ Кнопка остается в состоянии "Отписаться"
- ✅ Состояние не "ломается"

**Проверка:**
- 409 обрабатывается как "нормальный" конфликт
- Не показывается красный SnackBar
- Состояние синхронизируется через `ref.invalidate()`

---

### 6. Обработка ошибок: 400 Bad Request (подписка на себя)

**Шаги:**
1. Открыть свой собственный пост
2. Проверить, что кнопка "Подписаться" НЕ отображается

**Ожидаемый результат:**
- ✅ Кнопка подписки отсутствует (проверка `isMe` работает)
- ✅ Вместо кнопки показывается `SizedBox.shrink()`

**Альтернативный тест (если проверка `isMe` не работает):**
1. Временно изменить `isMe` на `false` в коде
2. Попытаться подписаться на свой пост

**Ожидаемый результат:**
- ✅ В Network видно запрос `POST /api/v2/subscriptions` со статусом `400 Bad Request`
- ✅ Появляется SnackBar: "Нельзя подписаться на самого себя"
- ✅ Состояние не меняется

---

### 7. Обновление счетчиков профиля

**Шаги:**
1. Открыть профиль автора поста (если есть экран профиля)
2. Запомнить количество подписчиков (`followers_count`)
3. Вернуться к посту
4. Подписаться на автора
5. Вернуться к профилю автора

**Ожидаемый результат:**
- ✅ Количество подписчиков увеличилось на 1
- ✅ Профиль обновился автоматически (благодаря `ref.invalidate(userByIdProvider(authorId))`)

**Проверка:**
- Инвалидация `userByIdProvider` работает корректно
- Счетчики обновляются на бэкенде

---

### 8. Проверка статуса подписки при загрузке

**Шаги:**
1. Подписаться на пользователя
2. Закрыть экран поста
3. Открыть пост того же пользователя снова

**Ожидаемый результат:**
- ✅ Кнопка сразу показывает "Отписаться" (не "Подписаться")
- ✅ Не происходит "мигания" кнопки
- ✅ Статус загружается через `isFollowingProvider`

**Проверка:**
- `isFollowingProvider` корректно определяет статус подписки
- Кэш провайдера работает правильно

---

### 9. Проверка лимита подписок (> 100)

**Шаги:**
1. Подписаться на более чем 100 пользователей (если возможно)
2. Открыть пост от пользователя, на которого подписан, но он не входит в первые 100

**Ожидаемый результат:**
- ⚠️ Кнопка может показать "Подписаться" вместо "Отписаться" (известное ограничение)
- ⚠️ Это временное ограничение до реализации `GET /subscriptions/check/:targetId`

**Примечание:** Это ожидаемое поведение согласно плану. После реализации легковесного endpoint на бэкенде проблема будет решена.

---

## Проверка логов в DevTools

### Frontend (Chrome DevTools Console)

- [ ] При нажатии "Подписаться" видно `DEBUG: Toggle follow START`
- [ ] В Network видно `POST /api/v2/subscriptions` с body `{target_id: "...", notifications_enabled: true}`
  - **Проверить:** `target_id` это строка (UUID), а не объект
- [ ] При успехе видно `DEBUG: Toggle follow SUCCESS`
- [ ] При ошибке видно `DEBUG: Toggle follow ERROR` с деталями
- [ ] При попытке подписаться на себя видно `400 Bad Request` и соответствующее сообщение
- [ ] Кнопка меняется с ElevatedButton на OutlinedButton при переходе в состояние "Отписаться"

### Backend (терминал)

- [ ] При `POST /subscriptions` видно SQL запрос `INSERT INTO subscriptions_users`
- [ ] При `DELETE /subscriptions/:targetId` видно SQL запрос `DELETE FROM subscriptions_users`
- [ ] При попытке повторной подписки видно ошибку `409 Conflict: Already subscribed`
- [ ] При попытке подписаться на себя видно `400 Bad Request: Cannot subscribe to yourself`
- [ ] Счетчики `following_count` и `followers_count` обновляются корректно
- [ ] После подписки счетчики в профиле автора обновляются (если открыт профиль)

---

## Критические проверки

### ✅ Защита от Race Conditions
- Флаг `_isTogglingFollow` блокирует повторные вызовы
- `ref.invalidate()` вызывается ПОСЛЕ `await`

### ✅ Типы данных
- `target_id` в JSON - это `String` (UUID), не объект
- Проверено в Network tab DevTools

### ✅ Безопасность
- Проверка `isMe` перед показом кнопки
- Обработка 400 ошибки для подписки на себя

### ✅ UI/UX
- ElevatedButton для "Подписаться" (акцентная кнопка)
- OutlinedButton для "Отписаться" (второстепенная)
- Loading индикатор во время запроса
- SnackBar с информативными сообщениями

---

## Известные ограничения

1. **Проверка статуса подписки:** Используется временное решение через список подписок с лимитом 100. Если у пользователя > 100 подписок, статус может определяться неверно.

2. **Endpoint для проверки:** `GET /subscriptions/check/:targetId` отсутствует на бэкенде. После его реализации нужно обновить `checkSubscription()` в `subscription_repository.dart`.

---

## Результаты тестирования

**Дата:** _______________

**Тестировщик:** _______________

| Сценарий | Статус | Комментарии |
|----------|--------|-------------|
| 1. Подписка | ⬜ | |
| 2. Отписка | ⬜ | |
| 3. Race Conditions | ⬜ | |
| 4. Нет интернета | ⬜ | |
| 5. 409 Conflict | ⬜ | |
| 6. 400 Bad Request | ⬜ | |
| 7. Обновление счетчиков | ⬜ | |
| 8. Проверка статуса | ⬜ | |
| 9. Лимит подписок | ⬜ | |

**Общий статус:** ⬜ Пройдено / ⬜ Требует исправлений

**Найденные проблемы:**
1. 
2. 
3. 
